{% extends '@admin/_adminBase.html' %}
{% import _self as navSet %}

{% block htmlTitle 'Navigation' %}
{% block headText 'Manage Navigation' %}
{% block sectionId 'navigation' %}

{% block sidebar %}
{# Get list of defined navigagors in Piton navigation.json #}
{% for navigator in page.navigators %}
<div class="sidebar-links">
  <a class="nav-link {{ navigator == page.navigator ? 'active' }}" href="{{ pathFor('adminNavigations', {'nav': navigator}) }}">
    <i class="fas fa-compass"></i>
    {{ navigator|capitalize }}</a>
</div>
{% endfor %}
{% endblock sidebar %}

{% block content %}


<h3>Navigation</h3>
{% if page.navigator %}
<strong>{{ page.navigator|capitalize }} Navigator</strong>

<form class="jsNavigatorForm" action="{{ pathFor('adminSaveNavigation') }}" method="post" accept-charset="utf-8">
  <input type="hidden" name="{{ site.csrf.name }}" value="{{ site.csrf.value }}">
  <input type="hidden" name="navigator" value="{{ page.navigator }}">
  <a class="mb-2 btn btn-warning my-3" href="{{ pathFor('adminNavigations', {'nav': page.navigator}) }}">Cancel</a>
  <button type="submit" class="btn btn-primary my-3" disabled>Save Navigation</button>

  <div class="jsEditNavBlock">
    <ol class="jsNavParent nav-parent">
      {{ navSet.navBlock(page.navigation) }}
    </ol>
  </div>

</form>

<hr>

<label>Add Page to Navigation</label>
<select class="form-control jsNavPageSelector">
  <option value="x" selected>Add a page to the navigation</option>
  <option value="0">[Dropdown]</option>
  {% for p in getNavPages() %}
  <option value="{{ p.id }}">{{ p.title }}</option>
  {% endfor %}
</select>

<div class="jsNewNavItem d-none">
  {{ navSet.navBlock([1]) }}
</div>
{% else %}
<p>No navigators are defined.</p>
{% endif %}

{% endblock content %}


{# This is a recursive function, which calls itself if the current nav item has a child #}
{% macro navBlock(nav) %}
{% import _self as navSet %}

{% for n in nav %}
<li class="nav-item nav-item-level-{{ n.level|default('1') }} {% if n.active == 'N' %}bg-warning text-white{% endif %} jsNavItem" data-level="{{ n.level }}" data-key="{{ n.id }}">
  <div class="jsNavItemTitle nav-parent-title">{{ n.page_title ?? n.nav_title }}</div>
  <input type="hidden" name="nav[{{ n.id }}][navId]" value="{{ n.id }}">
  <input type="hidden" class="jsNavPageId" name="nav[{{ n.id }}][pageId]" value="{{ n.page_id }}">
  <input type="hidden" class="jsNavParentId" name="nav[{{ n.id }}][parentId]" value="{{ n.parent_id }}">
  <input type="hidden" class="jsNavDeleteFlag" name="nav[{{ n.id }}][delete]" value="">
  <input type="hidden" class="jsNavActiveFlag" name="nav[{{ n.id }}][active]" value="{{ n.active }}">
  <input type="text" class="jsNavAltTitle" name="nav[{{ n.id }}][navTitle]" value="{{ n.nav_title }}" autocomplete="off" placeholder="Navigation title" {% if not n.page_id %}required{% endif %}>

  <div class="nav-controls">
    <i class="fa fa-eye-slash jsNavItemCtrl" data-control="disable" title="Disable"></i> |
    <i class="fa fa-arrow-up jsNavItemCtrl" data-control="up" title="Move Up"></i>
    <i class="fa fa-arrow-down jsNavItemCtrl" data-control="down" title="Move Down"></i> |
    <i class="fa fa-arrow-left jsNavItemCtrl" data-control="left" title="Move Left"></i>
    <i class="fa fa-arrow-right jsNavItemCtrl" data-control="right" title="Move Right"></i> |
    <i class="fa fa-trash-alt jsNavItemCtrl" data-control="delete" title="Delete"></i>
  </div>

  {% if n.childNav %}
  <ol class="jsNavParent nav-child">
    {{ navSet.navBlock(n.childNav) }}
  </ol>
  {% endif %}
</li>
{% endfor %}

{% endmacro navBlock %}


{% block foot %}
<script>
  // Listen for form input changes to update button status
  let navSaveIndFlag = false;
  const setNavSaveIndicator = () => {
    if (!navSaveIndFlag) {
      $('.jsNavigatorForm > button.btn').attr('disabled', false);
      navSaveIndFlag = true;
    }
  };
  $('.jsNavigatorForm').on('input', function() {
    setNavSaveIndicator();
  });

  // Add new page item to nav list
  let navItemKey = 0;
  $('.jsNavPageSelector').on('change', function () {
    if ($(this).val() !== "x") {
      let key = (navItemKey++) + "n";
      let $new = $('.jsNewNavItem > .jsNavItem').clone();
      $new.data('level', 1).data('key', key);
      $new.addClass('nav-item-new');
      $new.find('.jsNavPageId').val($(this).val());
      $new.find('.jsNavItemTitle').html($(this).find('option:selected').text());
      if ($(this).val() != 0) {
        $new.find('.jsNavAltTitle').attr('required',false);
      }
      $new.find('input[name^=nav]').each(function (i, e) {
        let name = $(e).attr('name');
        $(e).attr('name', name.replace(/(.+?\[)(\].+)/, "$1" + key + "$2"));
      });
      $('.jsEditNavBlock > .jsNavParent').append($new);
      setNavSaveIndicator();
    }
  });

  // Arrange nav items, as well as delete and disable
  $('.jsEditNavBlock').on('click', '.jsNavItemCtrl', function () {
    // Get nav item to move, direction, and zero index length of immediate siblings, and recursive level
    let $navItem = $(this).closest('.jsNavItem');
    let control = $(this).data('control');
    let navLength = $navItem.siblings('.jsNavItem').length;
    let level = $navItem.data('level');

    if (control === 'up' && $navItem.index() !== 0) {
      let $target = $navItem.prev('.jsNavItem');
      $navItem.detach();
      $target.before($navItem);
    } else if (control === 'down' && $navItem.index() !== navLength) {
      let $target = $navItem.next('.jsNavItem');
      $navItem.detach();
      $target.after($navItem);
    } else if (control === 'left' && level > 1) {
      // If ol is nested child of a jsNavItem, move up one level
      let $target = $navItem.closest('.jsNavParent').closest('.jsNavItem');
      $navItem.detach();
      let parentId = ($target.data('level') === 1) ? "" : $target.data('key');
      $navItem.removeClass('nav-item-level-' + level).addClass('nav-item-level-' + (level - 1));
      $navItem.data('level', level - 1)
      $navItem.find('.jsNavParentId').val(parentId);
      $target.after($navItem);
      // Clean up, if there is an empty <ol> left in this li, then remove
      let $empty = $target.find('.jsNavParent');
      if ($empty.is(':empty')) {
        $empty.remove();
      }
    } else if (control === 'right' && level <= 3 && $navItem.index() !== 0) {
      // The first child should not be indented
      // If the above sibling has a child <ol> then insert into that
      let $target = $navItem.prev('.jsNavItem');
      $navItem.find('.jsNavParentId').val($target.data('key'));
      $navItem.data('level', level + 1);
      $navItem.removeClass('nav-item-level-' + level).addClass('nav-item-level-' + (level + 1));
      if ($target.children('ol.jsNavParent').length === 1) {
        $navItem.detach();
        $target.children('ol.jsNavParent').append($navItem);
      } else if ($navItem.index() !== 0) {
        // Otherwise wrap in <ol> and insert into <li> above
        $target = $navItem.prev('.jsNavItem');
        $navItem.detach();
        $target.append($navItem);
        $navItem.wrap('<ol class="jsNavParent"></ol>');
      }
    } else if (control === 'delete') {
      // Get current status and reverse
      if ($navItem.find('.jsNavDeleteFlag').val() === "") {
        $navItem.find('.jsNavDeleteFlag').val("on");
        $navItem.addClass('bg-danger text-white');
      } else {
        $navItem.find('.jsNavDeleteFlag').val("");
        $navItem.removeClass('bg-danger text-white');
      }
    } else if (control === 'disable') {
      // Get current status and reverse
      if ($navItem.children('.jsNavActiveFlag').val() === "Y") {
        $navItem.children('.jsNavActiveFlag').val("N");
        $navItem.addClass('bg-warning text-white');
      } else {
        $navItem.children('.jsNavActiveFlag').val("Y");
        $navItem.removeClass('bg-warning text-white');
      }
    }
    setNavSaveIndicator();
  });
</script>
{% endblock foot %}